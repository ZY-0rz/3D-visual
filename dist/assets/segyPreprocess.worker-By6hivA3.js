(function(){let e=(e,t,n)=>Math.max(t,Math.min(n,e)),t=(e,t,n,r)=>{let i=e.length,a=Math.max(1,Math.floor(t)),o=Math.floor(a/2);r[0]=0;for(let t=0;t<i;t++)r[t+1]=r[t]+e[t];for(let e=0;e<i;e++){let t=Math.max(0,e-o),a=Math.min(i-1,e+o);n[e]=(r[a+1]-r[t])/(a-t+1)}},n=(e,t,n,r)=>{let i=e.length,a=Math.max(1,Math.floor(t)),o=Math.floor(a/2);r[0]=0;for(let t=0;t<i;t++){let n=e[t];r[t+1]=r[t]+n*n}for(let e=0;e<i;e++){let t=Math.max(0,e-o),a=Math.min(i-1,e+o),s=r[a+1]-r[t],c=a-t+1;n[e]=Math.sqrt(s/c)}},r=(t,n,r=2e5)=>{let i=t?.length??0;if(!i)return 1;let a=Math.max(1024,Math.min(r,i)),o=Math.max(1,Math.floor(i/a)),s=new Float32Array(Math.min(a,Math.ceil(i/o))),c=0;for(let e=0;e<i&&c<s.length;e+=o){let n=t[e];Number.isFinite(n)&&(s[c++]=n)}if(c===0)return 1;let l=Array.from(s.subarray(0,c));l.sort((e,t)=>e-t);let u=e(n/100,0,1),d=Math.max(0,Math.min(l.length-1,Math.floor(u*(l.length-1))));return Math.max(1e-6,l[d])},i=(e,i,a,o,s,c,l)=>{let u=e.length;if(l.removeDc){let t=0;for(let n=0;n<u;n++)t+=e[n];let n=t/u;for(let t=0;t<u;t++)e[t]-=n}if(l.bandpass){t(e,l.bpSmallWindow,i,s),t(e,l.bpLargeWindow,a,s);for(let t=0;t<u;t++)e[t]=i[t]-a[t]}if(l.agc){n(e,l.agcWindow,i,c);let t=0;for(let e=0;e<u;e++)t+=i[e];t/=u;for(let n=0;n<u;n++)e[n]=e[n]/(i[n]+1e-6)*t}if(l.winsorize){for(let t=0;t<u;t++)o[t]=Math.abs(e[t]);let t=r(o,l.winsorizeP);for(let n=0;n<u;n++){let r=e[n];e[n]=r>t?t:r<-t?-t:r}}};self.onmessage=e=>{let{buffer:t,dims:n,opts:r}=e.data||{},a=new Float32Array(t),o=n?.[0]??0,s=n?.[1]??0,c=n?.[2]??0,l=Math.max(0,o*s);if(!l||!c){self.postMessage({buffer:t},[t]);return}let u=new Float32Array(c),d=new Float32Array(c),f=new Float32Array(c),p=new Float32Array(c+1),m=new Float32Array(c+1),h=new Float32Array(c),g=Math.max(1,Math.floor(l/40));for(let e=0;e<l;e++){let t=e*c;for(let e=0;e<c;e++)h[e]=a[t+e];i(h,u,d,f,p,m,r);for(let e=0;e<c;e++)a[t+e]=h[e];e%g===0&&self.postMessage({progress:e/l})}self.postMessage({buffer:t,progress:1},[t])}})();